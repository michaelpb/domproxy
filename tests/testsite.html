<!doctype html>
<html>
  <head>
    <title>Test Site</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
    </style>
  </head>
  <body>
    <ul id="messages"></ul>
    <form>
      <input id="m" autocomplete="off" value="http://news.ycombinator.com/" /><button>Send</button>
    </form>
  <script src="/socket.io/socket.io.js"></script>

  <!--
  <script src="/-scripts/virtual-dom.js"></script>
  <script src="/-scripts/vdomserialize.js"></script>
        /*
        const vdomPatches = window.vdomserialize.deserializePatches(patch);
        console.log(vdomPatches);
        const root = window.virtualDom.create(initial);
        document.querySelector('html').innerHTML = '';
        document.querySelector('html').appendChild(root);
        window.virtualDom.patch(root, vdomPatches);
        */
  -->
  <script>
    const CREATE = 'CREATE';
    const REMOVE = 'REMOVE';
    const UPDATE_ATTRS = 'UPDATE_ATTRS';
    const UPDATE_TAGNAME = 'UPDATE_TAGNAME';
    const ATTR_CREATE = 'ATTR_CREATE';
    const ATTR_DELETE = 'ATTR_DELETE';
    const ATTR_UPDATE = 'ATTR_UPDATE';

    function doAction(node, actionInfo) {
      const actionName = actionInfo[0];

      if (actionName === CREATE) {
        const tagName = actionInfo[1];
        const attrs = actionInfo[2];
        const elem = document.createElement(tagName);
        for (const [key, value] of attrs) {
          elem.setAttribute(key, value);
        }
        node.appendChild(elem);

      } else if (actionName === REMOVE) {
        node.remove();

      } else if (actionName === UPDATE_ATTRS) {
        const attrActions = actionInfo[1];
        for (const [action, key, value] of attrActions) {
          if (action === ATTR_DELETE) {
            node.removeAttribute(key);
          } else {
            node.setAttribute(key, value);
          }
        }

      } else if (actionName === UPDATE_TAGNAME) {
        // Not implemented
        console.error('tagname swap not implemented');

      } 
    }

    function getNode(breadcrumbs) {
      let node = document.documentElement;
      for (const crumb of breadcrumbs) {
        const lastNode = node;
        node = node.children[crumb];
        if (!node) {
          console.error('was at', lastNode, '... cannot access', crumb);
          return null;
        }
      }
      return node;
    }

    function main() {
      var socket = io();
      socket.emit('ready', getDocumentHtml());
      socket.on('response', (payload) => {
        console.log('Received response length', payload.length);
        const data = JSON.parse(payload);
        const {patch, initial} = data;
        //console.log('patch', patch);
        for (const action of patch) {
          const breadcrumbs = action[0];
          const node = getNode(breadcrumbs);
          console.log(action[1][0]);
          if (node) {
            doAction(node, action[1]);
          }
        }

        console.log('loaded new patch');
      });
    }

    function getDocumentHtml() {
      const node = document.doctype;
      const doctypeString = "<!DOCTYPE "
              + node.name
              + (node.publicId ? ' PUBLIC "' + node.publicId + '"' : '')
              + (!node.publicId && node.systemId ? ' SYSTEM' : '')
              + (node.systemId ? ' "' + node.systemId + '"' : '')
              + '>';
      return doctypeString + document.documentElement.outerHTML;
    }

    main();
  </script>
</body>
</html>
